{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ food_detail.name }} - توضیحات</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/detail.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        #virtual-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background-color: #ff5733;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }
        #video-container {
            position: relative;
            width: 640px;  /* Adjusted width to match aspect ratio */
            height: 480px; /* Adjusted height to match aspect ratio */
            margin: 40px auto;
            background: #e9ecef;
            border-radius: 0;
            padding: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        #video, #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0; /* Ensure no border-radius is applied */
            object-fit: cover; /* This will ensure the video covers the container fully */
        }
    </style>
</head>
<body dir="rtl">
    <div class="container">
        <div class="food-detail">
            <h1 class="display-4">{{ food_detail.name }}</h1>
            <img src="{{ food_detail.photo.url }}" alt="{{ food_detail.name }}" class="img-fluid rounded">
            <p class="description">توضیحات: {{ food_detail.description }}</p>
            <p>قیمت: {{ food_detail.price }} تومان</p>
            <p>زمان لازم: {{ food_detail.time }} دقیقه</p>
            <p>امتیاز: {{ food_detail.rate }} از ۱۰۰</p>
        </div>

        <!-- Back Button -->
        <div class="mt-3">
            <a href="{% url 'menu:list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>بازگشت به منو</a>
        </div>

        <!-- Add Comment Section -->
        <div class="card mt-5">
            <div class="row">
                <div class="col-2">
                    <img src="https://i.imgur.com/xELPaag.jpg" width="70" class="rounded-circle mt-2">
                </div>
                <div class="col-10">
                    <div class="comment-box ml-2">
                        <h4>افزودن دیدگاه</h4>
                        <div class="rating"> 
                            <input type="radio" name="rating" value="5" id="5"><label for="5"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="4" id="4"><label for="4"><i class="fas fa-star"></i></label> 
                            <input type="radio" name="rating" value="3" id="3"><label for="3"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="2" id="2"><label for="2"><i class="fas fa-star"></i></label>
                            <input type="radio" name="rating" value="1" id="1"><label for="1"><i class="fas fa-star"></i></label>
                        </div>
                        <div class="comment-area">
                            <textarea class="form-control" placeholder="نظر شما چیست؟" rows="4"></textarea>
                        </div>
                        <div class="comment-btns mt-2">
                            <div class="row">
                                <div class="col-6">
                                    <div class="pull-left">
                                        <button class="btn btn-secondary btn-sm">لغو</button>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="pull-right">
                                        <button class="btn btn-success send btn-sm">ارسال <i class="fas fa-paper-plane ml-1"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Add Comment Section -->

        <div id="video-container">
            <video id="video" autoplay></video>
            <canvas id="outputCanvas"></canvas>
        </div>
        <div id="virtual-cursor"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="{% static 'js/detail.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script>
        const videoElement = document.getElementById('video');
        const outputCanvas = document.getElementById('outputCanvas');
        const virtualCursor = document.getElementById('virtual-cursor');
        const canvasCtx = outputCanvas.getContext('2d');

        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        hands.setOptions({
            maxNumHands: 1,  // Only track one hand
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();

        function onResults(results) {
            // Clear the canvas
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            // Draw the flipped video
            canvasCtx.translate(outputCanvas.width, 0);
            canvasCtx.scale(-1, 1);
            canvasCtx.drawImage(
                results.image, 0, 0, outputCanvas.width, outputCanvas.height);
            canvasCtx.restore();

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                const indexFingerTip = landmarks[8];
                const x = (1 - indexFingerTip.x) * window.innerWidth;
                const y = indexFingerTip.y * window.innerHeight;

                virtualCursor.style.left = `${x}px`;
                virtualCursor.style.top = `${y}px`;

                // Detect if the hand is in a fist (punch gesture)
                const thumbTip = landmarks[4];
                const distanceToThumb = Math.hypot(
                    (indexFingerTip.x - thumbTip.x) * window.innerWidth,
                    (indexFingerTip.y - thumbTip.y) * window.innerHeight
                );

                if (distanceToThumb < 50) {  // Adjust the threshold as needed
                    simulateClick(x, y);
                }

                // Scroll the page based on cursor position
                const upperBoundary = window.innerHeight * 0.25;
                const lowerBoundary = window.innerHeight * 0.75;

                if (y < upperBoundary) {
                    window.scrollBy(0, -30);  // Scroll up
                } else if (y > lowerBoundary) {
                    window.scrollBy(0, 30);  // Scroll down
                }
            }

            canvasCtx.restore();
        }

        function simulateClick(x, y) {
            const element = document.elementFromPoint(x, y);
            if (element) {
                element.click();
            }
        }
    </script>
</body>
</html>
